name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Which semantic version part to bump
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Calculate next version
        id: version
        run: |
          latest_tag=$(git tag --list 'v*.*.*' --sort=-version:refname | head -n1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi
          version=${latest_tag#v}
          IFS='.' read -r major minor patch <<< "$version"
          case "${{ inputs.bump }}" in
            major)
              major=$((major+1)); minor=0; patch=0 ;;
            minor)
              minor=$((minor+1)); patch=0 ;;
            patch)
              patch=$((patch+1)) ;;
          esac

          semver="${major}.${minor}.${patch}"
          semver_minor="${major}.${minor}"
          semver_major="${major}"
          new_tag="v${semver}"
          major_tag="v${semver_major}"
          minor_tag="v${semver_minor}"

          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "semver=$semver" >> "$GITHUB_OUTPUT"
          echo "semver_minor=$semver_minor" >> "$GITHUB_OUTPUT"
          echo "semver_major=$semver_major" >> "$GITHUB_OUTPUT"
          echo "major_tag=$major_tag" >> "$GITHUB_OUTPUT"
          echo "minor_tag=$minor_tag" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --tag ${{ steps.version.outputs.new_tag }} --unreleased

      - name: Update changelog file
        run: |
          printf "%s\n" "${{ steps.changelog.outputs.content }}" > CHANGELOG.md

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ steps.version.outputs.new_tag }}" || true
          git push origin main

      - name: Create and push release tags
        run: |
          git tag "${{ steps.version.outputs.new_tag }}"
          git tag -f "${{ steps.version.outputs.minor_tag }}"
          git tag -f "${{ steps.version.outputs.major_tag }}"
          git push origin "${{ steps.version.outputs.new_tag }}"
          git push origin -f "${{ steps.version.outputs.minor_tag }}"
          git push origin -f "${{ steps.version.outputs.major_tag }}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64/v8,linux/arm/v7
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.new_tag }}
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver }}
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver_minor }}
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver_major }}
            ghcr.io/${{ github.repository }}:latest

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.version.outputs.new_tag }}
          body: |
            ${{ steps.changelog.outputs.content }}

            Container tags:
            - ghcr.io/${{ github.repository }}:${{ steps.version.outputs.new_tag }}
            - ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver }}
            - ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver_minor }}
            - ghcr.io/${{ github.repository }}:${{ steps.version.outputs.semver_major }}
            - ghcr.io/${{ github.repository }}:latest
